{% extends 'DashboardBundle:Common:backend2.html.twig' %}

{% block breadcrumb %}
  <li><a href="#">Upgrade</a></li>
  <li><a href="#">Checkout</a></li>
{% endblock breadcrumb %}

{% block content %}
  <div class="card">
    <div class="title">
      <h5> Checkout </h5>
    </div>
    <div class="content">
      <h4>
        Payment Method:
      </h4>
      <div class="row">
        <div class="col s6">
          <ul class="collapsible" data-collapsible="accordion">
            {% if card_info %}
            <li class="active">
              <div class="collapsible-header active"><i class="fa fa-credit-card"></i>Pay with stored credit card</div>
              <div class="collapsible-body">
                <div>
                  <p style="padding: 10px">
                    Card: xxxx-xxxx-xxxx-{{ card_info.last4 }}
                  </p>
                </div>
                <div>
                  <p style="padding: 10px">
                    Type: {{ card_info.brand }}
                  </p>
                </div>
                <div class="container">
                    <center>
                      <div style="margin: 20px;">
                        <a class="btn" href="{{ path('upgrade_change_plan', {'plan_id':plan.id}) }}">
                          Process Checkout
                        </a>
                      </div>

                    </center>
                </div>
              </div>
            </li>
            {% endif %}
            <li class="{{ card_info ? '' : 'active' }}">
              <div class="collapsible-header {{ card_info ? '' : 'active' }}">
                <i class="fa {{ card_info ? 'fa-pencil' : 'fa-credit-card' }}"></i>{{ card_info ? 'Update' : 'Add' }} Credit Card</div>
              <div class="collapsible-body">
                  {% include 'DashboardBundle:Upgrade:Partials/_stripe_card_form.html.twig' with {'btn_title':'Process Checkout' } %}
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

{% endblock content %}

{% block javascripts %}
  {{ parent() }}
  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
  <script src="{{ asset('bundles/dashboard/assets/js/stripe.js') }}"></script>

  <script>
    MyStripe.init({
      form_selector: '#stripe-card-form'
    });

    MyStripe.success(function(token){
      var data = {
        token: token
      };
      $.post('{{ path('upgrade_update_card') }}', data, function(result){
        if(result.status == 'ok'){
          window.location.href = "{{ path('upgrade_change_plan', {'plan_id':plan.id}) }}";
        }
      });
    });
  </script>

{% endblock %}
